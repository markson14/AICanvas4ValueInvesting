<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaSeeker | æ™ºèƒ½ä»·å€¼æŠ•èµ„çœ‹æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#faf5ff', 100: '#f3e8ff', 200: '#e9d5ff', 500: '#a855f7', 600: '#9333ea', 700: '#7c3aed', 900: '#581c87' },
                        bull: '#16a34a',
                        bear: '#dc2626',
                        hold: '#d97706'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f8fafc; min-height: 100vh; color: #1e293b; }
        
        /* Header Inputs */
        .header-input { background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; padding: 6px 10px; font-weight: 600; font-size: 0.85rem; color: #334155; transition: all 0.2s; width: 100%; }
        .header-input:focus { outline: none; border-color: #a855f7; background: #fff; box-shadow: 0 0 0 3px rgba(168,85,247,0.15); }
        .header-label { font-size: 0.65rem; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; display: block; }
        
        /* Cards */
        .card { background: #fff; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-header { font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.1em; padding-bottom: 0.75rem; border-bottom: 1px solid #f1f5f9; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .card-header i { color: #a855f7; }
        
        /* Verdict Badges */
        .verdict-badge { font-size: 0.7rem; font-weight: 800; padding: 4px 12px; border-radius: 6px; text-transform: uppercase; }
        .verdict-buy { background: #dcfce7; color: #15803d; }
        .verdict-hold { background: #fef3c7; color: #b45309; }
        .verdict-reject { background: #fee2e2; color: #b91c1c; }
        
        /* Loader */
        .loader { border: 2px solid #e2e8f0; border-top-color: #a855f7; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 10px; font-weight: 600; font-size: 0.85rem; z-index: 1000; animation: slideIn 0.3s ease-out; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
        .toast-success { background: #16a34a; color: white; }
        .toast-error { background: #dc2626; color: white; }
        .toast-info { background: #2563eb; color: white; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Left Drawer */
        .drawer { position: fixed; top: 0; left: -340px; width: 320px; height: 100vh; background: #fff; border-right: 1px solid #e2e8f0; z-index: 100; transition: left 0.3s ease-in-out; padding: 20px; overflow-y: auto; box-shadow: 4px 0 15px rgba(0,0,0,0.05); }
        .drawer.open { left: 0; }
        .drawer-toggle { position: fixed; top: 100px; left: 12px; z-index: 101; background: #a855f7; color: white; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 4px 12px rgba(168,85,247,0.3); }
        .drawer-toggle:hover { background: #9333ea; transform: scale(1.05); }
        .drawer.open + .drawer-toggle { left: 332px; }
        
        /* Action Buttons */
        .action-btn { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(168,85,247,0.35); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .action-btn-secondary { background: #fff; border: 1px solid #e2e8f0; color: #475569; }
        .action-btn-secondary:hover { background: #f8fafc; border-color: #a855f7; color: #7c3aed; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        /* Master Card */
        .master-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; transition: all 0.2s; }
        .master-card:hover { background: #fff; border-color: #a855f7; box-shadow: 0 4px 12px rgba(168,85,247,0.1); }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.15); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a855f7; }
        
        /* Hero Stats */
        .stat-card { background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border: 1px solid #e9d5ff; border-radius: 12px; padding: 16px 20px; }
    </style>
</head>
<body class="pb-16">

    <!-- Left History Drawer -->
    <div id="historyDrawer" class="drawer">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-clock-rotate-left text-brand-500"></i> åˆ†ææ¡£æ¡ˆ
            </h3>
            <button onclick="toggleHistory()" class="text-slate-400 hover:text-slate-600">
                <i class="fas fa-xmark text-lg"></i>
            </button>
        </div>
        <select id="historyFilter" onchange="loadHistory()" class="w-full mb-4 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700 focus:outline-none focus:border-brand-500">
            <option value="">å…¨éƒ¨å…¬å¸</option>
        </select>
        <div id="historyList" class="space-y-3"></div>
    </div>
    <button class="drawer-toggle" onclick="toggleHistory()">
        <i class="fas fa-folder-open"></i>
    </button>

    <!-- Sticky Header -->
    <header class="fixed top-0 w-full bg-white/95 backdrop-blur-md border-b border-slate-200 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
                
                <!-- Logo & Ticker Input -->
                <div class="flex items-center gap-4 min-w-[280px]">
                    <div class="w-10 h-10 bg-gradient-to-br from-brand-500 to-brand-700 rounded-xl flex items-center justify-center text-xl font-black text-white shadow-lg shadow-brand-500/20">Î±</div>
                    <div class="flex gap-2">
                        <div class="w-28">
                            <label class="header-label">è‚¡ç¥¨ä»£ç </label>
                            <input type="text" id="inp-ticker" placeholder="9992.HK" class="header-input">
                        </div>
                        <div class="w-24">
                            <label class="header-label">å½“å‰è‚¡ä»·</label>
                            <input type="number" id="inp-price" placeholder="100" step="0.1" class="header-input !text-bull">
                        </div>
                    </div>
                </div>
                
                <!-- Core Financial Inputs -->
                <div class="flex flex-1 items-center gap-2 overflow-x-auto w-full justify-center lg:justify-end pb-1 lg:pb-0">
                    <div class="w-28 flex-shrink-0">
                        <label class="header-label">è¥æ”¶ (äº¿)</label>
                        <input type="text" id="fin-revenue" placeholder="100" class="header-input">
                    </div>
                    <div class="w-28 flex-shrink-0">
                        <label class="header-label">å‡€åˆ©æ¶¦ (äº¿)</label>
                        <input type="text" id="fin-profit" placeholder="20" class="header-input">
                    </div>
                    <div class="w-24 flex-shrink-0">
                        <label class="header-label">PE (TTM)</label>
                        <input type="text" id="fin-pe" placeholder="25" class="header-input">
                    </div>
                    <div class="w-28 flex-shrink-0">
                        <label class="header-label">å¢é•¿ç‡ (%)</label>
                        <input type="text" id="fin-growth" placeholder="30%" class="header-input">
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex items-center gap-2">
                    <button id="btn-analyze" onclick="runAnalysis()" class="action-btn">
                        <i class="fas fa-brain"></i> åˆ†æ/æ¨æ¼”
                    </button>
                    <button onclick="toggleConfig()" class="action-btn action-btn-secondary !px-3">
                        <i class="fas fa-gear text-slate-500"></i>
                    </button>
                    <button onclick="toggleImport()" class="action-btn action-btn-secondary !px-3">
                        <i class="fas fa-file-import text-slate-500"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 pt-28 space-y-6">
        
        <!-- Empty State -->
        <div id="emptyState" class="text-center py-20">
            <div class="text-6xl mb-6">ğŸ“Š</div>
            <h2 class="text-2xl font-bold text-slate-400 mb-2">æ¬¢è¿ä½¿ç”¨ AlphaSeeker</h2>
            <p class="text-slate-500 mb-8">è¾“å…¥è‚¡ç¥¨ä»£ç å’Œä»·æ ¼ï¼Œç‚¹å‡»ã€Œåˆ†æã€å¼€å§‹æ™ºèƒ½ä¼°å€¼</p>
            <div class="flex justify-center gap-4">
                <button onclick="document.getElementById('inp-ticker').focus()" class="action-btn">
                    <i class="fas fa-rocket"></i> å¼€å§‹åˆ†æ
                </button>
                <button onclick="toggleImport()" class="action-btn action-btn-secondary">
                    <i class="fas fa-file-import text-brand-500"></i> å¯¼å…¥ JSON
                </button>
            </div>
        </div>
        
        <!-- Dashboard (Hidden by default) -->
        <div id="dashboard" class="hidden space-y-6">
            
            <!-- Hero Section: Company + Key Stats -->
            <div class="card p-6">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h1 id="company-name" class="text-2xl font-black text-slate-900">---</h1>
                            <span id="txt-verdict" class="verdict-badge verdict-hold">HOLD</span>
                        </div>
                        <p id="txt-react-summary" class="text-sm text-slate-500"></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="stat-card text-center min-w-[100px]">
                            <div class="text-xs text-brand-600 uppercase font-bold mb-1">å…¬å…ä»·å€¼</div>
                            <div id="txt-fair-value" class="text-2xl font-black text-brand-700">---</div>
                        </div>
                        <div class="stat-card text-center min-w-[100px]">
                            <div class="text-xs text-brand-600 uppercase font-bold mb-1">å®‰å…¨è¾¹é™…</div>
                            <div id="txt-margin" class="text-2xl font-black text-bull">---</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Column (2/3) -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Business Model + Moat (Combined) -->
                    <div class="card p-6">
                        <div class="card-header"><i class="fas fa-building"></i> ç”Ÿæ„æ¨¡å¼ä¸æŠ¤åŸæ²³</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <p id="txt-business-summary" class="text-sm text-slate-600 leading-relaxed">---</p>
                                <div class="flex flex-wrap gap-2" id="txt-revenue-streams"></div>
                                <p id="txt-competitive-position" class="text-xs text-slate-400">---</p>
                            </div>
                            <div class="space-y-4">
                                <div class="flex items-center gap-3">
                                    <span id="txt-moat-type" class="text-sm font-bold text-brand-600">---</span>
                                    <span id="txt-moat-strength" class="text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded">---</span>
                                </div>
                                <p id="txt-moat-desc" class="text-sm text-slate-600 leading-relaxed">---</p>
                                <p id="txt-moat-risks" class="text-xs text-bear bg-red-50 p-3 rounded-lg border border-red-100">---</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Master Views -->
                    <div class="card p-6">
                        <div class="card-header"><i class="fas fa-users"></i> æŠ•èµ„å¤§å¸ˆå§”å‘˜ä¼š</div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Buffett -->
                            <div class="master-card">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-2xl">ğŸ§™â€â™‚ï¸</span>
                                    <span id="verdict-buffett" class="verdict-badge verdict-hold">HOLD</span>
                                </div>
                                <h4 class="text-sm font-bold text-slate-800 mb-2">å·´è²ç‰¹</h4>
                                <p id="txt-buffett-quote" class="text-xs text-slate-500 italic mb-2">"---"</p>
                                <p id="txt-buffett-reason" class="text-xs text-slate-400">---</p>
                            </div>
                            <!-- Munger -->
                            <div class="master-card">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-2xl">ğŸ§ </span>
                                    <span id="verdict-munger" class="verdict-badge verdict-hold">HOLD</span>
                                </div>
                                <h4 class="text-sm font-bold text-slate-800 mb-2">èŠ’æ ¼</h4>
                                <p id="txt-munger-quote" class="text-xs text-slate-500 italic mb-2">"---"</p>
                                <p id="txt-munger-reason" class="text-xs text-slate-400">---</p>
                            </div>
                            <!-- Duan -->
                            <div class="master-card">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-2xl">ğŸ§˜â€â™‚ï¸</span>
                                    <span id="verdict-duan" class="verdict-badge verdict-hold">HOLD</span>
                                </div>
                                <h4 class="text-sm font-bold text-slate-800 mb-2">æ®µæ°¸å¹³</h4>
                                <p id="txt-duan-quote" class="text-xs text-slate-500 italic mb-2">"---"</p>
                                <p id="txt-duan-reason" class="text-xs text-slate-400">---</p>
                            </div>
                        </div>
                    </div>

                    <!-- Valuation -->
                    <div class="card p-6">
                        <div class="card-header"><i class="fas fa-calculator"></i> ä¼°å€¼æ¨¡å‹ <span id="txt-model-type" class="ml-2 text-brand-600 bg-brand-50 px-2 py-0.5 rounded">---</span></div>
                        <div class="space-y-3 text-sm">
                            <div>
                                <label class="text-xs text-slate-400 uppercase font-bold">æ¨¡å‹é€‰æ‹©ç†ç”±</label>
                                <p id="txt-val-model-reason" class="text-slate-600 mt-1">---</p>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 uppercase font-bold">å…³é”®å‡è®¾</label>
                                <p id="txt-val-assumptions" class="text-slate-600 mt-1">---</p>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 uppercase font-bold">ä¼°å€¼å‚æ•°</label>
                                <pre id="txt-val-params" class="text-xs text-brand-600 bg-slate-50 p-3 rounded-lg mt-1 overflow-x-auto border border-slate-100">---</pre>
                            </div>
                        </div>
                        <!-- Reasoning Trace (Collapsible) -->
                        <div class="mt-4 pt-4 border-t border-slate-100">
                            <button onclick="toggleTrace()" class="text-xs text-slate-400 hover:text-brand-600 flex items-center gap-2">
                                <i id="icon-trace" class="fas fa-chevron-down"></i> å®Œæ•´æ¨ç†è¿‡ç¨‹
                            </button>
                            <p id="txt-reasoning" class="hidden text-xs text-slate-500 mt-3 whitespace-pre-wrap bg-slate-50 p-3 rounded-lg border border-slate-100">---</p>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Right Column (1/3) -->
                <div class="space-y-6">
                    
                    <!-- Radar Chart -->
                    <div class="card p-6">
                        <div class="card-header"><i class="fas fa-chart-radar"></i> ç»¼åˆè¯„åˆ†</div>
                        <div class="h-52">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- North Star Metrics -->
                    <div class="card p-6">
                        <div class="card-header"><i class="fas fa-star text-amber-500"></i> åŒ—ææ˜ŸæŒ‡æ ‡</div>
                        <div id="metrics-container" class="space-y-2 mb-4"></div>
                        <div class="flex gap-2">
                            <input type="text" id="new-metric-name" placeholder="æŒ‡æ ‡åç§°" class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-700 focus:outline-none focus:border-brand-500">
                            <input type="text" id="new-metric-val" placeholder="å€¼" class="w-20 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs text-slate-700 focus:outline-none focus:border-brand-500">
                            <button onclick="addMetric()" class="action-btn !px-3 !py-2 text-xs">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Config Modal -->
    <div id="configModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800">API é…ç½®</h3>
                <button onclick="toggleConfig()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="header-label">Base URL</label>
                    <input type="text" id="configBaseUrl" class="w-full header-input">
                </div>
                <div>
                    <label class="header-label">API Key</label>
                    <input type="password" id="configKey" class="w-full header-input">
                </div>
                <div>
                    <label class="header-label">Model</label>
                    <input type="text" id="configModel" class="w-full header-input">
                </div>
                <button onclick="saveConfig()" class="w-full action-btn justify-center">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800">å¯¼å…¥åˆ†ææ•°æ®</h3>
                <button onclick="toggleImport()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-xmark"></i></button>
            </div>
            <textarea id="jsonInput" rows="12" placeholder="ç²˜è´´ JSON æ•°æ®..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700 font-mono resize-none mb-4 focus:outline-none focus:border-brand-500"></textarea>
            <button onclick="processImport()" class="w-full action-btn justify-center">å¯¼å…¥å¹¶æ¸²æŸ“</button>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        let state = {
            config: {
                baseUrl: localStorage.getItem('ls_base_url') || 'https://api.openai.com/v1',
                apiKey: localStorage.getItem('ls_api_key') || '',
                model: localStorage.getItem('ls_model') || 'gpt-4o'
            },
            currentData: null,
            chart: null,
            metrics: [],
            editingMetricIndex: null
        };

        // === INIT ===
        (async function init() {
            document.getElementById('configBaseUrl').value = state.config.baseUrl;
            document.getElementById('configKey').value = state.config.apiKey;
            document.getElementById('configModel').value = state.config.model;
            
            const historyList = await loadHistory();
            
            if (window.location.search.includes('load=1')) {
                const record = JSON.parse(sessionStorage.getItem('loadRecord') || 'null');
                if (record) {
                    sessionStorage.removeItem('loadRecord');
                    restoreData(record);
                    history.replaceState({}, '', window.location.pathname);
                    return;
                }
            }
            
            if (historyList && historyList.length > 0) {
                try {
                    restoreData(historyList[0], false);
                    showToast("å·²è‡ªåŠ¨è½½å…¥æœ€æ–°åˆ†æè®°å½•", "info");
                } catch (e) {
                    console.error("Auto-load failed", e);
                }
            }
        })();

        // === CORE FUNCTIONS ===
        async function runAnalysis() {
            const ticker = document.getElementById('inp-ticker').value;
            const price = parseFloat(document.getElementById('inp-price').value);
            if (!ticker || isNaN(price)) return showToast('è¯·è¾“å…¥æœ‰æ•ˆä¿¡æ¯', 'error');

            setPrimaryLoading(true, 'å¤„ç†ä¸­...');
            try {
                // å…ˆæŒ‰ ticker åˆ¤æ–­æ˜¯å¦å­˜åœ¨å†å²ï¼šæ— åˆ™èµ° /analyzeï¼Œæœ‰åˆ™èµ° /react
                let history = [];
                try {
                    const historyRes = await fetch(`${API_BASE}/history?ticker=${encodeURIComponent(ticker)}`);
                    if (historyRes.ok) history = await historyRes.json();
                } catch (e) {
                    console.log('[AlphaSeeker][history_fetch_failed]', { ticker, err: String(e), ts: new Date().toISOString() });
                }

                const hasHistory = Array.isArray(history) && history.length > 0;
                console.log('[AlphaSeeker][click_analyze_or_react]', { ticker, hasHistory, ts: new Date().toISOString() });

                if (!hasHistory) {
                    setPrimaryLoading(true, 'åˆ†æä¸­...');
                const payload = { ticker, price, custom_metrics: state.metrics };
                const res = await fetch(`${API_BASE}/analyze`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                state.currentData = data;
                state.currentData.ticker = ticker;
                state.metrics = data.north_star_metrics || [];
                renderDashboard(data, price);
                showToast("åˆ†æå®Œæˆ", "success");
                } else {
                    setPrimaryLoading(true, 'æ¨æ¼”ä¸­...');
                    const latest = history[0];
                    const oldContext = latest?.data || null;
                    if (!oldContext) throw new Error('å†å²è®°å½•ç¼ºå°‘ dataï¼Œæ— æ³•æ¨æ¼”');

                    const snapshot = {
                        metrics: {
                            revenue: document.getElementById('fin-revenue').value,
                            net_profit: document.getElementById('fin-profit').value,
                            pe_ttm: document.getElementById('fin-pe').value,
                            revenue_growth_yoy: document.getElementById('fin-growth').value
                        },
                        period: "Latest"
                    };

                    const res = await fetch(`${API_BASE}/react`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            old_context: oldContext,
                            financial_snapshot: snapshot,
                            custom_metrics: state.metrics,
                            price: isNaN(price) ? null : price
                        })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    const result = await res.json();
                    state.currentData = result;
                    state.metrics = result.north_star_metrics || [];
                    renderDashboard(state.currentData, price);
                    showToast("æ¨æ¼”å®Œæˆ", "success");
                }

                // æˆåŠŸååˆ·æ–°å†å²åˆ—è¡¨ï¼Œç¡®ä¿è½è¡¨å¯è§
                try { await loadHistory(); } catch (e) {}
            } catch (e) { showToast(e.message, 'error'); } 
            finally { setPrimaryLoading(false); }
        }

        async function triggerReact() {
            if (!state.currentData) return showToast("è¯·å…ˆè¿›è¡ŒåŸºç¡€åˆ†æ", "error");
            
            setPrimaryLoading(true, 'æ¨æ¼”ä¸­...');
            showToast("æ­£åœ¨è¿›è¡Œ ReAct æ¨æ¼”...", "info");

            const price = parseFloat(document.getElementById('inp-price').value);
            
            const snapshot = {
                metrics: {
                    revenue: document.getElementById('fin-revenue').value,
                    net_profit: document.getElementById('fin-profit').value,
                    pe_ttm: document.getElementById('fin-pe').value,
                    revenue_growth_yoy: document.getElementById('fin-growth').value
                },
                period: "Latest"
            };
            
            try {
                const res = await fetch(`${API_BASE}/react`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        old_context: state.currentData, 
                        financial_snapshot: snapshot,
                        custom_metrics: state.metrics,
                        price: isNaN(price) ? null : price
                    })
                });
                
                if (!res.ok) throw new Error(await res.text());
                const result = await res.json();
                
                // Backend now returns complete merged data, just use it directly
                state.currentData = result;
                state.metrics = result.north_star_metrics || [];
                
                renderDashboard(state.currentData, parseFloat(document.getElementById('inp-price').value));
                showToast("ReAct æ¨æ¼”å®Œæˆ", "success");
                
            } catch (e) { 
                showToast(e.message, 'error'); 
            } finally {
                setPrimaryLoading(false);
            }
        }

        async function loadHistory() {
            try {
                const filter = document.getElementById('historyFilter').value;
                const url = filter ? `${API_BASE}/history?ticker=${filter}` : `${API_BASE}/history`;
                const res = await fetch(url);
                const history = await res.json();
                
                if (!filter) {
                    const tickers = [...new Set(history.map(h => h.ticker))];
                    const select = document.getElementById('historyFilter');
                    const currentVal = select.value;
                    select.innerHTML = '<option value="">å…¨éƒ¨å…¬å¸</option>' + tickers.map(t => `<option value="${t}">${t}</option>`).join('');
                    select.value = currentVal;
                }

                const container = document.getElementById('historyList');
                container.innerHTML = history.map(item => `
                    <div class="bg-slate-50 p-3 rounded-lg cursor-pointer hover:bg-brand-50 border border-slate-100 hover:border-brand-200 transition-all" onclick='restoreData(${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                        <div class="flex justify-between font-bold text-sm text-slate-800">
                            <span>${item.ticker}</span>
                            <span class="text-xs text-slate-400">${new Date(item.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="text-xs text-slate-500 mt-1 truncate">${item.data?.company_name || '---'}</div>
                        ${item.price !== undefined && item.price !== null ? `<div class="text-[11px] text-slate-400 mt-1">è‚¡ä»·ï¼š${item.price}</div>` : ''}
                    </div>
                `).join('');
                
                return history;
            } catch(e) { 
                console.log('History load failed:', e); 
                return [];
            }
        }

        // === RENDERING ===
        function renderDashboard(data, currentPrice) {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Company Header
            document.getElementById('company-name').innerText = `${data.company_name || '---'} (${data.currency || '---'})`;
            document.getElementById('txt-react-summary').innerText = data.react_summary || '';
            
            // Business Model
            const bm = data.business_model || {};
            document.getElementById('txt-business-summary').innerText = bm.summary || data.analysis_normal?.essence || data.analysis_normal?.business_essence || '---';
            document.getElementById('txt-revenue-streams').innerHTML = (bm.revenue_streams || []).map(s => `<span class="bg-brand-100 text-brand-700 px-2 py-1 rounded text-xs font-medium">${s}</span>`).join('') || '';
            document.getElementById('txt-competitive-position').innerText = bm.competitive_position || '';

            // Moat
            const moat = data.moat_analysis || {};
            document.getElementById('txt-moat-type').innerText = moat.moat_type || '---';
            document.getElementById('txt-moat-strength').innerText = `å¼ºåº¦: ${moat.moat_strength || '---'}`;
            document.getElementById('txt-moat-desc').innerText = moat.moat_description || data.analysis_normal?.moat_status || '---';
            document.getElementById('txt-moat-risks').innerText = `âš ï¸ ${moat.moat_risks || '---'}`;

            // Masters
            const masters = data.master_views || {};
            renderMaster('buffett', masters.buffett, data.analysis_normal);
            renderMaster('munger', masters.munger, data.analysis_normal);
            renderMaster('duan', masters.duanyongping, data.analysis_normal);

            // Valuation
            document.getElementById('txt-model-type').innerText = data.valuation_type || '---';
            const valExp = data.valuation_explanation || {};
            document.getElementById('txt-val-model-reason').innerText = valExp.model_choice_reason || '---';
            document.getElementById('txt-val-assumptions').innerText = valExp.key_assumptions || '---';
            document.getElementById('txt-val-params').innerText = JSON.stringify(data.valuation_params || {}, null, 2);
            document.getElementById('txt-reasoning').innerText = data.reasoning_trace || data.valuation_adjustment_reasoning || data.verdict_reasoning || "";

            renderChart(data.radar_scores);
            renderMetricsList();
            calculateValuationDisplay(data.valuation_params, data.valuation_type, currentPrice, data.fair_value_range);
        }

        function renderMaster(id, masterData, fallback) {
            const verdictEl = document.getElementById(`verdict-${id}`);
            const quoteEl = document.getElementById(`txt-${id}-quote`);
            const reasonEl = document.getElementById(`txt-${id}-reason`);

            if (masterData) {
                const v = masterData.verdict?.toUpperCase() || 'HOLD';
                verdictEl.innerText = v;
                verdictEl.className = `verdict-badge verdict-${v.toLowerCase() === 'buy' ? 'buy' : v.toLowerCase() === 'reject' ? 'reject' : 'hold'}`;
                quoteEl.innerText = `"${masterData.quote || '---'}"`;
                reasonEl.innerText = masterData.reasoning || '';
            } else if (fallback) {
                const key = id === 'duan' ? 'duanyongping_quote' : `${id}_quote`;
                quoteEl.innerText = `"${fallback[key] || '---'}"`;
                verdictEl.innerText = 'N/A';
                verdictEl.className = 'verdict-badge bg-slate-200 text-slate-600';
                reasonEl.innerText = '';
            }
        }

        function renderChart(scores) {
            if (!scores) return;
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (state.chart) state.chart.destroy();
            state.chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['æŠ¤åŸæ²³', 'ç®¡ç†å±‚', 'è´¢åŠ¡', 'å¢é•¿', 'ä¼°å€¼'],
                    datasets: [{
                        data: [scores.moat, scores.management, scores.financials, scores.growth, scores.valuation],
                        backgroundColor: 'rgba(168, 85, 247, 0.15)',
                        borderColor: '#a855f7',
                        pointBackgroundColor: '#a855f7',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 10, ticks: { display: false, stepSize: 2 }, pointLabels: { color: '#64748b', font: { size: 11, weight: '600' } }, grid: { color: '#e2e8f0' }, angleLines: { color: '#e2e8f0' } } },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: true
                }
            });
        }

        function renderMetricsList() {
            const container = document.getElementById('metrics-container');
            container.innerHTML = state.metrics.map((m, i) => `
                ${state.editingMetricIndex === i ? `
                    <div class="bg-slate-50 p-3 rounded-lg border border-brand-100 text-xs">
                        <div class="flex flex-col gap-2">
                            <div class="flex gap-2">
                                <input id="edit-metric-name-${i}" class="flex-1 bg-white border border-slate-200 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-brand-500" value="${escapeHtml(m.name || '')}" placeholder="æŒ‡æ ‡åç§°">
                                <input id="edit-metric-val-${i}" class="w-24 bg-white border border-slate-200 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-brand-500" value="${escapeHtml(m.current_value || '')}" placeholder="å€¼">
                                <input id="edit-metric-unit-${i}" class="w-16 bg-white border border-slate-200 rounded-lg px-2 py-1 text-xs focus:outline-none focus:border-brand-500" value="${escapeHtml(m.unit || '')}" placeholder="å•ä½">
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="text-[11px] text-slate-400">
                                    ${m.broken_threshold ? `âš ï¸ <${escapeHtml(String(m.broken_threshold))}` : ''}
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="saveMetricEdit(${i})" class="action-btn !px-3 !py-2 text-xs"><i class="fas fa-check"></i></button>
                                    <button onclick="cancelMetricEdit()" class="action-btn action-btn-secondary !px-3 !py-2 text-xs"><i class="fas fa-xmark"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-100 text-xs group hover:bg-brand-50 hover:border-brand-100 transition-all">
                    <div>
                        <span class="font-bold text-slate-700">${m.name}:</span>
                        <span class="text-brand-600 ml-1 font-semibold">${m.current_value} ${m.unit||''}</span>
                    </div>
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        ${m.broken_threshold ? `<span class="text-[9px] text-bear font-medium">âš ï¸ &lt;${m.broken_threshold}</span>` : ''}
                            <button onclick="startEditMetric(${i})" class="text-slate-400 hover:text-brand-600"><i class="fas fa-edit"></i></button>
                        <button onclick="removeMetric(${i})" class="text-slate-400 hover:text-bear"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                `}
            `).join('');
        }

        function addMetric() {
            const name = document.getElementById('new-metric-name').value;
            const val = document.getElementById('new-metric-val').value;
            if (name && val) {
                state.metrics.push({ name, current_value: val, unit: '' });
                renderMetricsList();
                document.getElementById('new-metric-name').value = '';
                document.getElementById('new-metric-val').value = '';
            }
        }
        
        function removeMetric(i) { state.metrics.splice(i, 1); renderMetricsList(); }
        
        function editMetric(i) {
            const m = state.metrics[i];
            const newName = prompt("ä¿®æ”¹æŒ‡æ ‡åç§°:", m.name);
            if (newName === null) return;
            const newVal = prompt("ä¿®æ”¹æŒ‡æ ‡å€¼:", m.current_value);
            if (newVal === null) return;
            if (newName && newVal) {
                state.metrics[i] = { ...m, name: newName, current_value: newVal };
                renderMetricsList();
            }
        }

        function startEditMetric(i) {
            state.editingMetricIndex = i;
            renderMetricsList();
            setTimeout(() => {
                const el = document.getElementById(`edit-metric-name-${i}`);
                if (el) el.focus();
            }, 0);
        }

        function cancelMetricEdit() {
            state.editingMetricIndex = null;
            renderMetricsList();
        }

        function saveMetricEdit(i) {
            const m = state.metrics[i] || {};
            const name = document.getElementById(`edit-metric-name-${i}`)?.value?.trim();
            const val = document.getElementById(`edit-metric-val-${i}`)?.value?.trim();
            const unit = document.getElementById(`edit-metric-unit-${i}`)?.value?.trim();
            if (!name || !val) return showToast("æŒ‡æ ‡åç§°å’Œå€¼ä¸èƒ½ä¸ºç©º", "error");
            state.metrics[i] = { ...m, name, current_value: val, unit: unit || '' };
            state.editingMetricIndex = null;
            renderMetricsList();
        }

        function calculateValuationDisplay(params, type, currentPrice, fairValueRange) {
            if (!params && !fairValueRange) return;
            
            let fairValue = 0;
            
            // Use fair_value_range if available (from ReAct)
            if (fairValueRange && fairValueRange.mid) {
                fairValue = fairValueRange.mid;
            } else if (params) {
                if (type === 'DCF') {
                    const fcf = params.fcf_per_share || 0, r = params.discount_rate || 0.1, g = params.terminal_growth || 0.02;
                    fairValue = (fcf > 0 && r > g) ? (fcf * (1+g) / (r - g)) : fcf * 15;
                } else if (type === 'PEG') {
                    fairValue = (params.eps || 0) * (params.fair_peg || 1) * ((params.growth_rate||0)*100);
                } else if (type === 'PB') {
                    fairValue = (params.bps || 0) * (params.fair_pb || 1);
                } else if (type === 'PS') {
                    fairValue = (params.sps || 0) * (params.fair_ps || 1);
                }
            }

            const margin = currentPrice > 0 && fairValue > 0 ? ((fairValue - currentPrice) / fairValue) * 100 : 0;
            document.getElementById('txt-fair-value').innerText = fairValue > 0 ? fairValue.toFixed(2) : '---';
            
            const mEl = document.getElementById('txt-margin');
            mEl.innerText = fairValue > 0 ? margin.toFixed(1) + "%" : '---';
            mEl.className = margin > 0 ? "text-2xl font-black text-bull" : "text-2xl font-black text-bear";
            
            const vEl = document.getElementById('txt-verdict');
            if(margin > 30) { vEl.innerText = "BUY"; vEl.className = "verdict-badge verdict-buy"; }
            else if(margin < -20) { vEl.innerText = "SELL"; vEl.className = "verdict-badge verdict-reject"; }
            else { vEl.innerText = "HOLD"; vEl.className = "verdict-badge verdict-hold"; }
        }

        function getFinancialSnapshot() {
            return {
                revenue: document.getElementById('fin-revenue').value,
                net_profit: document.getElementById('fin-profit').value,
                pe_ttm: document.getElementById('fin-pe').value,
                revenue_growth_yoy: document.getElementById('fin-growth').value
            };
        }

        function restoreData(item, closeDrawer = true) {
            document.getElementById('inp-ticker').value = item.ticker || '';
            if (item.price !== undefined && item.price !== null && !isNaN(parseFloat(item.price))) {
                document.getElementById('inp-price').value = parseFloat(item.price);
            }
            state.currentData = item.data;
            if (state.currentData) state.currentData.ticker = item.ticker;
            state.metrics = item.data?.north_star_metrics || [];
            
            // Restore financial inputs
            if (item.data?.financial_snapshot) {
                const f = item.data.financial_snapshot;
                document.getElementById('fin-revenue').value = f.revenue || '';
                document.getElementById('fin-profit').value = f.net_profit || '';
                document.getElementById('fin-pe').value = f.pe_ttm || '';
                document.getElementById('fin-growth').value = f.revenue_growth_yoy || '';
            }
            
            if (item.data) {
                renderDashboard(item.data, parseFloat(document.getElementById('inp-price').value) || 0);
            }
            if (closeDrawer) document.getElementById('historyDrawer').classList.remove('open');
        }

        async function processImport() {
            try {
                const json = JSON.parse(document.getElementById('jsonInput').value);
                
                if (json.ticker) document.getElementById('inp-ticker').value = json.ticker;
                // æ”¯æŒå¯¼å…¥ JSON è‡ªå¸¦ priceï¼ˆç”¨äºè‡ªåŠ¨å¡«å……è‚¡ä»·è¾“å…¥æ¡†ï¼‰
                if (
                    json.price !== undefined &&
                    json.price !== null &&
                    !isNaN(parseFloat(json.price))
                ) {
                    document.getElementById("inp-price").value = parseFloat(json.price);
                }
                
                const fs = json.financial_snapshot || {};
                document.getElementById('fin-revenue').value = fs.revenue || '';
                document.getElementById('fin-profit').value = fs.net_profit || '';
                document.getElementById('fin-pe').value = fs.pe_ttm || '';
                document.getElementById('fin-growth').value = fs.revenue_growth_yoy || '';
                
                if (json.company_name) {
                    state.currentData = json;
                    state.metrics = json.north_star_metrics || [];
                    renderDashboard(json, parseFloat(document.getElementById('inp-price').value) || 0);
                    showToast("å®Œæ•´åˆ†æå·²å¯¼å…¥", "success");
                } else {
                    showToast("è´¢æŠ¥æ•°æ®å·²å¯¼å…¥ï¼Œè¯·ç‚¹å‡»ã€Œåˆ†æ/æ¨æ¼”ã€", "info");
                }

                // å¯¼å…¥åè‡ªåŠ¨è½è¡¨åˆ° history.jsonl
                const tickerToSave =
                    (json && json.ticker) ||
                    document.getElementById("inp-ticker")?.value ||
                    "UNKNOWN";
                // ç¡®ä¿ data å†…ä¹Ÿæœ‰ tickerï¼ˆreact ä¼šç”¨åˆ°ï¼‰
                if (json && !json.ticker) json.ticker = tickerToSave;

                // priceï¼šä¼˜å…ˆè¾“å…¥æ¡†ï¼Œå…¶æ¬¡å¯¼å…¥ JSON çš„ price
                let priceVal = parseFloat(document.getElementById("inp-price")?.value || "");
                if (isNaN(priceVal) && json && json.price !== undefined) {
                    priceVal = parseFloat(json.price);
                }

                try {
                    const res = await fetch(`${API_BASE}/save`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            ticker: tickerToSave || "UNKNOWN",
                            data: json || {},
                            price: isNaN(priceVal) ? null : priceVal,
                            timestamp: new Date().toISOString(),
                        }),
                    });
                    if (!res.ok) throw new Error(await res.text());

                    // ä¿å­˜æˆåŠŸåï¼Œå¼ºåˆ¶åˆ‡å›â€œå…¨éƒ¨å…¬å¸â€å¹¶åˆ·æ–°åˆ—è¡¨ï¼Œç¡®ä¿å¯è§
                    const filterEl = document.getElementById("historyFilter");
                    if (filterEl) filterEl.value = "";
                    await loadHistory();
                    showToast(`å·²è½è¡¨ï¼š${tickerToSave || "UNKNOWN"}`, "success");
                } catch (e) {
                    console.log("Auto-save failed:", e);
                    showToast("å¯¼å…¥å·²å®Œæˆï¼Œä½†è½è¡¨å¤±è´¥", "error");
                }
                
                toggleImport();
            } catch (e) { showToast("JSON æ ¼å¼é”™è¯¯: " + e.message, "error"); }
        }
        
        function exportData() {
            if (!state.currentData) return showToast("æš‚æ— æ•°æ®å¯å¯¼å‡º", "error");
            const dataStr = JSON.stringify(state.currentData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.currentData.ticker || 'analysis'}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("å·²å¯¼å‡º", "success");
        }

        // === HELPERS ===
        function setLoading(type, loading) {
            const btn = document.getElementById(`btn-${type}`);
            if (!btn) return;
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = `<div class="loader w-4 h-4"></div> ${type === 'analyze' ? 'åˆ†æä¸­...' : 'æ¨æ¼”ä¸­...'}`;
            } else {
                btn.disabled = false;
                btn.innerHTML = type === 'analyze' 
                    ? '<i class="fas fa-brain"></i> åˆ†æ/æ¨æ¼”' 
                    : '<i class="fas fa-bolt text-brand-500"></i> ReAct';
            }
        }

        function setPrimaryLoading(loading, label) {
            const btn = document.getElementById('btn-analyze');
            if (!btn) return;
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = `<div class="loader w-4 h-4"></div> ${label || 'å¤„ç†ä¸­...'}`;
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-brain"></i> åˆ†æ/æ¨æ¼”';
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        function showToast(msg, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>${msg}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        function toggleConfig() { 
            const m = document.getElementById('configModal');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }
        
        function toggleImport() { 
            const m = document.getElementById('importModal');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }
        
        function toggleHistory() { 
            document.getElementById('historyDrawer').classList.toggle('open'); 
            if(document.getElementById('historyDrawer').classList.contains('open')) loadHistory();
        }
        
        function toggleTrace() { 
            document.getElementById('txt-reasoning').classList.toggle('hidden'); 
            const icon = document.getElementById('icon-trace');
            icon.classList.toggle('fa-chevron-up');
            icon.classList.toggle('fa-chevron-down');
        }
        
        function saveConfig() {
            state.config.baseUrl = document.getElementById('configBaseUrl').value;
            state.config.apiKey = document.getElementById('configKey').value;
            state.config.model = document.getElementById('configModel').value;
            localStorage.setItem('ls_base_url', state.config.baseUrl);
            localStorage.setItem('ls_api_key', state.config.apiKey);
            localStorage.setItem('ls_model', state.config.model);
            showToast("é…ç½®å·²ä¿å­˜", "success");
            toggleConfig();
        }
    </script>
</body>
</html>
